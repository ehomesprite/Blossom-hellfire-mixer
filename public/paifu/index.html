<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
	<script src="Chart.bundle.js"></script>
</head>
<body>
	<input type="file" id="files" name="files[]" multiple />
	<output id="list"></output>
	<textarea id="paifuList" rows=20></textarea>
	<button id="submit" onclick="onbuildpaifuJSON()">Submit</button>
	<div id="drop_zone" style="width:800px;height:25px;text-align:center;padding:80px">Drop files here</div>
	<span><canvas id="kyokuChart" width="800" height="400"></canvas></span>
	<span><canvas id="pointChart" width="400" height="400"></canvas></span>
	<canvas id="yakuChart" width="1600" height="400"></canvas>
	<script>
		function onbuildpaifuJSON(){
			xhttp.open("POST", "http://104.160.43.29:8080/tenhou/api/submit", true);
                        xhttp.setRequestHeader("Content-type","application/json");
                        xhttp.send(document.getElementById("paifuList").value);
			//buildpaifuJSON(document.getElementById("paifuList").innerHTML);
		}
		function buildpaifuJSON(data){
			var pbase=0;
                        var pfloat=0;
                        while(pbase>=0)
                        {
                        	var pbase=str.indexOf("file",pfloat);
                                var pfloat=str.indexOf("&",pbase);
                                        if(pbase>0)
                                        {
                                                var result=decodeURIComponent(str.substring(pbase+5,pfloat));
                                                var div = document.createElement('div');
                                                div.innerHTML = result;
                                                document.getElementById('list').insertBefore(div, null)
                                                request.logcodes[request.logcodes.length]=result;
                                        }
                                }
                        xhttp.open("POST", "http://104.160.43.29:8080/tenhou/api/submit", true);
                        xhttp.setRequestHeader("Content-type","application/json");
                        var sendjson = JSON.stringify(request);
                        xhttp.send(sendjson);
		}
		window.onload=function(){
			xhttp.open("POST", "http://104.160.43.29:8080/tenhou/api/submit", true); 
			xhttp.setRequestHeader("Content-type","application/json");
			var surejson = '{ "logcodes":[ "2016072020gm-00c1-0000-e0f49746", "2016072020gm-0089-0000-e83a8b43", "2016072101gm-0089-0000-0a870c91", "2016072223gm-0009-5770-d6ddf3d6", "2016072316gm-0089-0000-0b7b37ca", "2016072316gm-0089-0000-9bf292a3", "2016072323gm-0009-1022-3e77685a", "2016072400gm-0009-1022-85e8f4e4", "2016071022gm-0089-0000-ead7674a" ], "username":"四位縛り" }'
			var lidyjson = '{"logcodes":["2015101119gm-0001-0000-x7ff4b2c2f88a","2016021217gm-0019-2057-x19dfb84e229d","2016021217gm-0019-2057-x10df691f91c8","2016021217gm-0019-2057-xb6ab633716e8","2016021220gm-0019-2057-xa99d6c7c3d09","2016021220gm-0019-2057-x9a1cd08a825f","2016021221gm-0019-2057-x6570c4ff2237","2016021221gm-0019-2057-x1bb87c2cc186","2016021222gm-0019-2057-xd9d06928ab42","2016021222gm-0019-2057-x4ad0b86b81f8","2016022022gm-0009-4400-xd560bf39f81a","2016022023gm-0009-4400-xb6ddc82c287c","2016030317gm-0019-4575-x063afe3fbba5","2016030318gm-0019-4575-x29beaedeef2c","2016030318gm-0019-4575-x175d70dc9aab","2016030622gm-0009-4710-x5b548bed180a","2016030623gm-0009-4710-x29aab999134c","2016050201gm-0009-3042-x0e03dc56d02a","2016050215gm-0011-6205-xededaa9dcbf7","2016050215gm-0051-6205-xd491d3d731df","2016050215gm-0009-6205-x4d9ef71011f7"],"username":"lzqyydy"}'
			xhttp.send(lidyjson); 
		}
		// Check for the various File API support.
		if(window.File && window.FileReader && window.FileList && window.Blob) {
			// Great success! All the File APIs are supported.
		}
		else{
			alert('The File APIs are not fully supported in this browser.');
		}
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
		    if (xhttp.readyState == 4 && xhttp.status == 200) {
		        var userstats = JSON.parse(xhttp.responseText);
		        console.log(userstats);
		        var kyokuctx = document.getElementById("kyokuChart");
		        var pointctx = document.getElementById("pointChart");
		        var yakuctx = document.getElementById("yakuChart");
		        var kyokuChart = new Chart(kyokuctx, {
					type: 'bar',
					data: {
						labels: ["立直率", "副露率", "和了率", "放铳率", "流局率"],
						datasets: [{
							label: '比率',
							data: [userstats.data.riichiRate, userstats.data.fuuruRate, userstats.data.agariRate, userstats.data.jyuRate, userstats.data.ryukyokuRate],
							backgroundColor: [
								'rgba(255, 99, 132, 0.2)',
								'rgba(54, 162, 235, 0.2)',
								'rgba(255, 206, 86, 0.2)',
								'rgba(75, 192, 192, 0.2)',
								'rgba(153, 102, 255, 0.2)'
							],
							borderColor: [
								'rgba(255,99,132,1)',
								'rgba(54, 162, 235, 1)',
								'rgba(255, 206, 86, 1)',
								'rgba(75, 192, 192, 1)',
								'rgba(153, 102, 255, 1)'
							],
							borderWidth: 1
						}]
					},
					options: {
						responsive: false,
						scales: {yAxes: [{ticks: {beginAtZero:true}}]}}
				});
				var pointChart = new Chart(pointctx, {
					type: 'bar',
					data: {
						labels: ["平均和了点", "平均放铳点"],
						datasets: [{
							label: '点',
							data: [userstats.data.avAgariPoints, userstats.data.avjyuPoints],
							backgroundColor: [
								'rgba(255, 99, 132, 0.2)',
								'rgba(54, 162, 235, 0.2)',
							],
							borderColor: [
								'rgba(255,99,132,1)',
								'rgba(54, 162, 235, 1)'
							],
							borderWidth: 1
						}]
					},
					options: {
						responsive: false,
						scales: {yAxes: [{ticks: {beginAtZero:true}}]}}
				});
				var yakuChart = new Chart(yakuctx, {
					type: 'bar',
					data: {
						labels: ["门前清自摸和","立直","一发","抢杠","岭上开花","海底捞月","河底捞鱼","平和","断幺","一杯口","自风东","自风南","自风西","自风北","场风东","场风南","场风西","场风北","役牌白","役牌发","役牌中","双立直","七对子","混全带幺九","一气通贯","三色同顺","三色同刻","三杠子","对对和","三暗刻","小三元","混老头","两杯口","纯全带幺九","混一色","清一色","人和","天和","地和","大三元","四暗刻","四暗刻单骑","字一色","绿一色","清老头","九莲宝灯","纯正九莲宝灯","国士无双","国士无双十三面","大四喜","小四喜","四杠子","宝牌","里宝牌","赤宝牌"
						],
						datasets: [{
							label: '# of Votes',
							data: [userstats.data.yakusRate[0],userstats.data.yakusRate[1],userstats.data.yakusRate[2],userstats.data.yakusRate[3],userstats.data.yakusRate[4],userstats.data.yakusRate[5],userstats.data.yakusRate[6],userstats.data.yakusRate[7],userstats.data.yakusRate[8],userstats.data.yakusRate[9],userstats.data.yakusRate[10],userstats.data.yakusRate[11],userstats.data.yakusRate[12],userstats.data.yakusRate[13],userstats.data.yakusRate[14],userstats.data.yakusRate[15],userstats.data.yakusRate[16],userstats.data.yakusRate[17],userstats.data.yakusRate[18],userstats.data.yakusRate[19],userstats.data.yakusRate[20],userstats.data.yakusRate[21],userstats.data.yakusRate[22],userstats.data.yakusRate[23],userstats.data.yakusRate[24],userstats.data.yakusRate[25],userstats.data.yakusRate[26],userstats.data.yakusRate[27],userstats.data.yakusRate[28],userstats.data.yakusRate[29],userstats.data.yakusRate[30],userstats.data.yakusRate[31],userstats.data.yakusRate[32],userstats.data.yakusRate[33],userstats.data.yakusRate[34],userstats.data.yakusRate[35],userstats.data.yakusRate[36],userstats.data.yakusRate[37],userstats.data.yakusRate[38],userstats.data.yakusRate[39],userstats.data.yakusRate[40],userstats.data.yakusRate[41],userstats.data.yakusRate[42],userstats.data.yakusRate[43],userstats.data.yakusRate[44],userstats.data.yakusRate[45],userstats.data.yakusRate[46],userstats.data.yakusRate[47],userstats.data.yakusRate[48],userstats.data.yakusRate[49],userstats.data.yakusRate[50],userstats.data.yakusRate[51],userstats.data.yakusRate[52],userstats.data.yakusRate[53],userstats.data.yakusRate[54]],
							backgroundColor: ['rgba(255, 99, 132, 0.2)','rgba(54, 162, 235, 0.2)','rgba(255, 206, 86, 0.2)','rgba(75, 192, 192, 0.2)','rgba(153, 102, 255, 0.2)','rgba(255, 159, 64, 0.2)','rgba(255, 99, 132, 0.2)','rgba(54, 162, 235, 0.2)','rgba(255, 206, 86, 0.2)','rgba(75, 192, 192, 0.2)','rgba(153, 102, 255, 0.2)','rgba(255, 159, 64, 0.2)','rgba(255, 99, 132, 0.2)','rgba(54, 162, 235, 0.2)','rgba(255, 206, 86, 0.2)','rgba(75, 192, 192, 0.2)','rgba(153, 102, 255, 0.2)','rgba(255, 159, 64, 0.2)','rgba(255, 99, 132, 0.2)','rgba(54, 162, 235, 0.2)','rgba(255, 206, 86, 0.2)','rgba(75, 192, 192, 0.2)','rgba(153, 102, 255, 0.2)','rgba(255, 159, 64, 0.2)','rgba(255, 99, 132, 0.2)','rgba(54, 162, 235, 0.2)','rgba(255, 206, 86, 0.2)','rgba(75, 192, 192, 0.2)','rgba(153, 102, 255, 0.2)','rgba(255, 159, 64, 0.2)','rgba(255, 99, 132, 0.2)','rgba(54, 162, 235, 0.2)','rgba(255, 206, 86, 0.2)','rgba(75, 192, 192, 0.2)','rgba(153, 102, 255, 0.2)','rgba(255, 159, 64, 0.2)','rgba(255, 99, 132, 0.2)','rgba(54, 162, 235, 0.2)','rgba(255, 206, 86, 0.2)','rgba(75, 192, 192, 0.2)','rgba(153, 102, 255, 0.2)','rgba(255, 159, 64, 0.2)','rgba(255, 99, 132, 0.2)','rgba(54, 162, 235, 0.2)','rgba(255, 206, 86, 0.2)','rgba(75, 192, 192, 0.2)','rgba(153, 102, 255, 0.2)','rgba(255, 159, 64, 0.2)','rgba(255, 99, 132, 0.2)','rgba(54, 162, 235, 0.2)','rgba(255, 206, 86, 0.2)','rgba(75, 192, 192, 0.2)','rgba(153, 102, 255, 0.2)','rgba(255, 159, 64, 0.2)','rgba(255, 99, 132, 0.2)',
							],
							borderColor: ['rgba(255,99,132,1)','rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)','rgba(75, 192, 192, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)','rgba(255,99,132,1)','rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)','rgba(75, 192, 192, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)','rgba(255,99,132,1)','rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)','rgba(75, 192, 192, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)','rgba(255,99,132,1)','rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)','rgba(75, 192, 192, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)','rgba(255,99,132,1)','rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)','rgba(75, 192, 192, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)','rgba(255,99,132,1)','rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)','rgba(75, 192, 192, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)','rgba(255,99,132,1)','rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)','rgba(75, 192, 192, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)','rgba(255,99,132,1)','rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)','rgba(75, 192, 192, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)','rgba(255,99,132,1)','rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)','rgba(75, 192, 192, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)','rgba(255,99,132,1)',
							],
							borderWidth: 1
						}]
					},
					options: {
						responsive: false,
						scales: {yAxes: [{ticks: {beginAtZero:true}}]}}
				});
		    }
		};
		function handleFileSelect_button(evt) {
			var files = evt.target.files; // FileList object

			// files is a FileList of File objects. List some properties.
			var output = [];
			for (var i = 0, f; f = files[i]; i++) {

				// Only process image files.
				//if (!f.type.match('image.*')) {
				//	continue;
				//}
				var reader = new FileReader();
				var request = {logcodes:[],username:"lzqyydy"};
				// Closure to capture the file information.
				reader.onload = (function(theFile) {
					return function(e) {
						var data=e.target.result.substr(37);
						var str=atob(data);
						var pbase=0;
						var pfloat=0;
						while(pbase>=0)
						{
							var pbase=str.indexOf("file",pfloat);
							var pfloat=str.indexOf("&",pbase);
							if(pbase>0)
							{
								var result=decodeURIComponent(str.substring(pbase+5,pfloat));
								var div = document.createElement('div');
								div.innerHTML = result;
								document.getElementById('list').insertBefore(div, null)
								request.logcodes[request.logcodes.length]=result;
							}
						}
						xhttp.open("POST", "http://104.160.43.29:8080/tenhou/api/submit", true); 
						xhttp.setRequestHeader("Content-type","application/json");
						var sendjson = JSON.stringify(request);
						xhttp.send(sendjson); 
						// Render thumbnail.
						//var span = document.createElement('span');
						//span.innerHTML = ['<img class="thumb" src="', e.target.result,'" title="', escape(theFile.name), '"/>'].join('');
						//;
					};
				})(f);

				// Read in the image file as a data URL.
				reader.readAsDataURL(f);
			}
			document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
		}
		function handleFileSelect_field(evt) {
			evt.stopPropagation();
			evt.preventDefault();

			var files = evt.dataTransfer.files; // FileList object.

			// files is a FileList of File objects. List some properties.
			var output = [];
			for (var i = 0, f; f = files[i]; i++) {
				output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
							f.size, ' bytes, last modified: ',
							f.lastModifiedDate.toLocaleDateString(), '</li>');
			}
			document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
		}
		document.getElementById('files').addEventListener('change', handleFileSelect_button, false);  

		function handleDragOver(evt) {
			evt.stopPropagation();
			evt.preventDefault();
			evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
		}

		// Setup the dnd listeners.
		var dropZone = document.getElementById('drop_zone');
		dropZone.addEventListener('dragover', handleDragOver, false);
		dropZone.addEventListener('drop', handleFileSelect_field, false);
	</script>
	<canvas id="demoChart" width="400" height="400"></canvas>
	<script>
	// var democtx = document.getElementById("demoChart");
	// var myChart = new Chart(democtx, {
	// 	type: 'bar',
	// 	data: {
	// 		labels: ["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],
	// 		datasets: [{
	// 			label: '# of Votes',
	// 			data: [12, 19, 3, 5, 2, 3],
	// 			backgroundColor: [
	// 				'rgba(255, 99, 132, 0.2)',
	// 				'rgba(54, 162, 235, 0.2)',
	// 				'rgba(255, 206, 86, 0.2)',
	// 				'rgba(75, 192, 192, 0.2)',
	// 				'rgba(153, 102, 255, 0.2)',
	// 				'rgba(255, 159, 64, 0.2)'
	// 			],
	// 			borderColor: [
	// 				'rgba(255,99,132,1)',
	// 				'rgba(54, 162, 235, 1)',
	// 				'rgba(255, 206, 86, 1)',
	// 				'rgba(75, 192, 192, 1)',
	// 				'rgba(153, 102, 255, 1)',
	// 				'rgba(255, 159, 64, 1)'
	// 			],
	// 			borderWidth: 1
	// 		}]
	// 	},
	// 	options: {
	// 		responsive: false,
	// 		scales: {yAxes: [{ticks: {beginAtZero:true}}]}}
	//});
	</script>
</body>
</html>
